<!DOCTYPE html>
<html>
<head>
    <title>Timing Gate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
</head>
<body>
    <div class="topnav">
        <h1>Timing Gate</h1>
    </div>
    <div class="content">
        <div class="top-grid">
            <div class="top-card">
                <p ;>
                    <button id="connectBleButton" class="connectButton" ><span id="bleState">Connect</span></button>
                    <!-- <button id="disconnectBleButton" class="disconnectButton"> Disconnect</button> -->
                </p>
                <!--<p class="gray-label">BLE state: <strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong></p>-->
                <p>
                    <table style="width: 90%; table-layout: fixed; font-size: 1rem";margin-top: 0;margin-bottom: 0; >
                    <thead><tr><th>Gate 1</th><th>Gate 2</th><th>Gate 3</th></tr></thead><tbody>
                    <tr><td><div id="Led1" class="red led"></div></td><td><div id="Led2" class="red led"></div></td><td><div id="Led3" class="red led"></div></td></tr>
                    </tbody></table></body></html>
                </p>
                <p > <span>
                    <button id="onButton" class="onButton" style="display: inline-block; "</button> Gates Only</button>
                        <span id="blueLed" class="led-off" style="display: inline-block"></span> 
                        <span  id="yellowLed" class="led-off" style="display: inline-block"></span>  
                        <span id="whiteLed" class="led-off" style="display: inline-block"></span>  
                    </span>
                </p>


            </div>
            
        </div>
    </div>
    <div id="valueContainer" class="card-grid" > 
      <! cards added here<!-- Dynamic cards will be added here by JavaScript -->        
    </div>
 

</body>
<script>
    // DOM Elements
    const connectButton = document.getElementById('connectBleButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const onButton = document.getElementById('onButton');
    const offButton = document.getElementById('offButton');
    const retrievedValue = document.getElementById('valueContainer');
    const latestValueSent = document.getElementById('valueSent');
    const bleStateContainer = document.getElementById('bleState');
    const indicatorLed1 = document.getElementById('Led1');
    const indicatorLed2 = document.getElementById('Led2');
    const indicatorLed3 = document.getElementById('Led3');
    const yellowLed = document.getElementById('yellowLed');
    const blueLed = document.getElementById('blueLed');
    const whiteLed = document.getElementById('whiteLed');
    //const timestampContainer = document.getElementById('timestamp');

    //Define BLE Device Specs
    var deviceName ='TimingGate';
    var bleService = '19b10000-e8f2-537e-4f6c-d104768a1214';
    var ledCharacteristic = '19b10002-e8f2-537e-4f6c-d104768a1214';
    var sensorCharacteristic= '19b10001-e8f2-537e-4f6c-d104768a1214';

    //Global Variables to Handle Bluetooth
    var bleServer;
    var bleServiceFound;
    var sensorCharacteristicFound;

    
    // Connect Button (search for BLE Devices only if BLE is available)
    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    // Disconnect Button
   // disconnectButton.addEventListener('click', disconnectDevice);

    // Write to the ESP32 LED Characteristic
    onButton.addEventListener('click', () => writeOnCharacteristic(1));
    //offButton.addEventListener('click', () => writeOnCharacteristic(0));

    // Check if BLE is available in your Browser
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            console.log('Web Bluetooth API is not available in this browser!');
            bleStateContainer.innerHTML = "Web Bluetooth API is not available in this browser/device!";
            return false
        }
        console.log('Web Bluetooth API supported in this browser.');
        return true
    }

    function createCard(decodedValue) {
        let htmlContent = `<div class="card">
                            <h2>Gate Times</h2>
                                <p class="reading"><span>
                                    <table style="width: 95%; table-layout: fixed; font-size: 1.5rem">
                                    <thead><tr><th>Gate</th><th>Time</th><th>Split</th></tr></thead><tbody>`
        arraySplit = decodedValue.split("|");
        arraySplit.forEach( newtime => {
             if (newtime != "") {
                splitInfo=newtime.split(":")
                htmlContent = htmlContent + "<tr><td>" + splitInfo[0] + "</td><td>" + splitInfo[1]  + "</td><td>" + splitInfo[2] + "</td></tr>"
             }
            });
                                     
        htmlContent = htmlContent +`
                        "</tbody></table>"
                    </span></p>
                    <p class="date-label">Date: <span>${getDateTime()}</span></p>
                </div> `
        return htmlContent
    }

    function toggleGateIndicator(decodedValue){
        arrayInd=decodedValue.split(":")
        switch(arrayInd[1]) {
            case "1":
                if (arrayInd[2]=="on") {
                    indicatorLed1.className="green led"
                } else if (arrayInd[2]=="wait") {
                    indicatorLed1.className="orange led"
                } else {
                    indicatorLed1.className="red led"
                }
                break;
            case "2":
                if (arrayInd[2]=="on") {
                    indicatorLed2.className="green led"
                } else if (arrayInd[2]=="wait") {
                    indicatorLed2.className="orange led"
                } else {
                    indicatorLed2.className="red led"
                }
                break;
            case "3":
                if (arrayInd[2]=="on") {
                    indicatorLed3.className="green led"
                } else if (arrayInd[2]=="wait") {
                    indicatorLed3.className="orange led"
                } else {
                    indicatorLed3.className="red led"
                }
                break;
        }

    }
    function toggleLed (decodedValue){
        arrayLed=decodedValue.split(":")
        switch(arrayLed[1]) {
            case "White":
                if (arrayLed[2]=="on") {
                    whiteLed.className="led-white"
                } else {
                    whiteLed.className="led-off"
                }
                break;
            case "Yellow":
                if (arrayLed[2]=="on") {
                    yellowLed.className="led-yellow"
                } else {
                    yellowLed.className="led-off"
                }
                break;
            case "Blue":
                if (arrayLed[2]=="on") {
                    blueLed.className="led-blue"
                } else {
                    blueLed.className="led-off"
                }
                break;
        }

    }

    // Connect to BLE Device and Enable Notifications
    function connectToDevice(){
        console.log('Initializing Bluetooth...');
        navigator.bluetooth.requestDevice({
            filters: [{name: deviceName}],
            optionalServices: [bleService]
        })
        .then(device => {
            console.log('Device Selected:', device.name);
            bleStateContainer.innerHTML = 'Connected' ;
 
            device.addEventListener('gattservicedisconnected', onDisconnected);
            return device.gatt.connect();
        })
        .then(gattServer =>{
            bleServer = gattServer;
            console.log("Connected to GATT Server");
            return bleServer.getPrimaryService(bleService);
        })
        .then(service => {
            bleServiceFound = service;
            console.log("Service discovered:", service.uuid);
            return service.getCharacteristic(sensorCharacteristic);
        })
        .then(characteristic => {
            console.log("Characteristic discovered:", characteristic.uuid);
            sensorCharacteristicFound = characteristic;
            characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicChange);
            characteristic.startNotifications();
            console.log("Notifications Started.");
            return characteristic.readValue();
        })
        .then(value => {
            console.log("Read value: ", value);
            const decodedValue = new TextDecoder().decode(value);
            console.log("Decoded value: ", decodedValue);
            if(decodedValue.startsWith("Gate")) {
                toggleGateIndicator(decodedValue)
            }
            else {
                const newcard=createCard (decodedValue) 
                retrievedValue.insertAdjacentHTML ('afterbegin',newcard)
            }
            
            


        })
        .catch(error => {
            console.log('Error: ', error);
        })
    }

    function onDisconnected(event){
        console.log('Device Disconnected:', event.target.device.name);
        bleStateContainer.innerHTML = "Device disconnected";
        bleStateContainer.style.color = "#d13a30";

        connectToDevice();
    }

    function handleCharacteristicChange(event){
        const newValueReceived = new TextDecoder().decode(event.target.value);
        console.log("Characteristic value changed: ", newValueReceived);
        if(newValueReceived.startsWith("Gate")) {
            toggleGateIndicator(newValueReceived)
        } 
        else if (newValueReceived.startsWith("Mode")) {
            mode=newValueReceived.split(":")
            onButton.innerHTML=mode[1]
        }
        else if (newValueReceived.startsWith("Led:")) {
            toggleLed(newValueReceived)
        }
        else {
            const newcard=createCard (newValueReceived) 
            retrievedValue.insertAdjacentHTML ('afterbegin',newcard)
        }
        
    }

    function writeOnCharacteristic(value){
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(ledCharacteristic)
            .then(characteristic => {
                console.log("Found the LED characteristic: ", characteristic.uuid);
                const data = new Uint8Array([value]);
                return characteristic.writeValue(data);
            })
            .then(() => {
                //onButton.innerHTML = "sent";
                console.log("Value written to LEDcharacteristic:", value);
            })
            .catch(error => {
                console.error("Error writing to the LED characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }

    function disconnectDevice() {
        console.log("Disconnect Device.");
        if (bleServer && bleServer.connected) {
            if (sensorCharacteristicFound) {
                sensorCharacteristicFound.stopNotifications()
                    .then(() => {
                        console.log("Notifications Stopped");
                        return bleServer.disconnect();
                    })
                    .then(() => {
                        console.log("Device Disconnected");
                        bleStateContainer.innerHTML = "Device Disconnected";
                        bleStateContainer.style.color = "#d13a30";

                    })
                    .catch(error => {
                        console.log("An error occurred:", error);
                    });
            } else {
                console.log("No characteristic found to disconnect.");
            }
        } else {
            // Throw an error if Bluetooth is not connected
            console.error("Bluetooth is not connected.");
            window.alert("Bluetooth is not connected.")
        }
    }

    function getDateTime() {
        var currentdate = new Date();
        var day = ("00" + currentdate.getDate()).slice(-2); // Convert day to string and slice
        var month = ("00" + (currentdate.getMonth() + 1)).slice(-2);
        var year = currentdate.getFullYear();
        var hours = ("00" + currentdate.getHours()).slice(-2);
        var minutes = ("00" + currentdate.getMinutes()).slice(-2);
        var seconds = ("00" + currentdate.getSeconds()).slice(-2);
        
        var datetime = day + "/" + month + "/" + year + " at " + hours + ":" + minutes + ":" + seconds;
        return datetime;
    }


</script>

</html>